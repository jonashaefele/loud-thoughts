# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

LoudThoughts Plugin - A sync service connecting Obsidian notes to AudioPen, VoiceNotes, and Alfie via Firebase real-time sync.

## Architecture

Monorepo structure with yarn workspaces:
- `plugin/` - Obsidian plugin (TypeScript, Vite build)
- `functions/` - Firebase Cloud Functions (Node.js 18)
- `web/` - Web dashboard (SolidJS + TailwindCSS)
- `shared/` - Shared types and Firebase config

## Development Commands

**Pre-Release Validation (MANDATORY):**
```bash
cd plugin && yarn build    # Must compile without errors
yarn lint                  # From root - all workspaces must pass
```

### Plugin Development
```bash
cd plugin
yarn build          # Build plugin to dist/
```

### Firebase Functions
```bash
cd functions
yarn build          # Compile TypeScript
yarn serve          # Local development with emulators
yarn deploy         # Deploy to Firebase
yarn logs           # View function logs
```

### Web Dashboard
```bash
cd web
yarn dev            # Development server
yarn build          # Production build
yarn serve          # Preview build
```

### Code Quality
```bash
yarn lint           # Run ESLint across all workspaces (from root)
```

## Key Files and Entry Points

- **Plugin Entry**: `plugin/main.ts` - Core plugin logic with Firebase listeners
- **Settings UI**: `plugin/ui/SettingsTab.ts` - User configuration interface
- **Firebase Functions**: `functions/src/index.ts` - Webhook endpoint and auth
- **Web App**: `web/src/App.tsx` - Dashboard for webhook URL generation
- **Plugin Manifest**: `plugin/manifest.json` - Obsidian plugin metadata
- **Build Config**: `plugin/vite.config.js` - Custom Vite configuration for plugin build

## Development Best Practices

### ðŸŽ¯ Core Development Principles

1. **Monorepo Coordination**
   - Changes to `shared/` types affect all workspaces
   - Test plugin changes with Firebase emulators before deployment
   - Verify web dashboard changes don't break webhook generation

2. **Firebase Integration Testing**
   - Always test with emulators first: `cd functions && yarn serve`
   - Verify real-time sync works before deploying
   - Check auth token generation and validation

3. **Obsidian Plugin Standards**
   - Use `Notice` for user feedback, not console.log
   - Clean up Firebase listeners in onunload()
   - Test with different vault configurations

4. **Complete Feature Delivery**
   - Update all workspaces when adding new services (AudioPen, VoiceNotes, Alfie)
   - Update templates when adding new variables
   - Test sync modes (overwrite, append, prepend, new) thoroughly

### ðŸ“‹ Pre-Release Checklist

**Before releasing new plugin version:**
- âœ… **Build Check**: `cd plugin && yarn build` - Must compile without errors
- âœ… **Lint Check**: `yarn lint` from root - All workspaces pass
- âœ… **Manifest Version**: Update version in `plugin/manifest.json`
- âœ… **Firebase Deploy**: If functions changed, `cd functions && yarn deploy`
- âœ… **Test Sync**: Verify sync works with all supported services
- âœ… **Migration Path**: If breaking changes, provide clear migration instructions

## Development Patterns

1. **Firebase Real-time Sync**: Plugin listens to Firebase Realtime Database at `/users/{userId}/buffer/` for new notes
2. **Template System**: Templates use variable substitution (e.g., `{{note}}`, `{{date}}`, `{{tags}}`)
3. **Error Handling**: Use Obsidian's `Notice` for user notifications
4. **Status Updates**: Update status bar during sync operations
5. **TypeScript**: Strict typing with shared interfaces in `shared/` workspace

## Firebase Configuration

- **Region**: europe-west1
- **Authentication**: Custom tokens generated by Cloud Functions
- **Database Structure**: `/users/{userId}/buffer/` for note sync
- **Emulators**: Configured for local development (auth, functions, database, hosting)

## Important Notes

- Always build plugin with `yarn build` in the plugin directory before testing
- Firebase functions use Node.js 18 runtime
- Web dashboard is hosted at https://loud-thoughts.web.app
- Plugin supports AudioPen, VoiceNotes, and Alfie services
- No test suite - rely on ESLint and manual testing

## Developer Onboarding

### Initial Setup
1. **Clone and Install**
   ```bash
   git clone git@github.com:jonashaefele/loud-thoughts.git
   cd loud-thoughts
   yarn install
   ```

2. **Firebase Setup**
   - Install Firebase CLI: `npm install -g firebase-tools`
   - Login: `firebase login`
   - Select project: `firebase use loud-thoughts`

3. **Local Development**
   ```bash
   # Terminal 1: Firebase emulators
   cd functions && yarn serve
   
   # Terminal 2: Web dashboard
   cd web && yarn dev
   
   # Terminal 3: Build plugin
   cd plugin && yarn build
   ```

4. **Test in Obsidian**
   - Copy `plugin/dist/*` to your vault's `.obsidian/plugins/loud-thoughts/`
   - Enable plugin in Obsidian settings
   - Configure with token from web dashboard

### Common Issues

- **Build fails**: Check Node version (18+ required)
- **Sync not working**: Verify Firebase project configuration
- **Plugin not loading**: Check Obsidian console for errors
- **Template issues**: Verify markdown template syntax