# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

LoudThoughts Plugin - A sync service connecting Obsidian notes to AudioPen, VoiceNotes, and Alfie via Firebase real-time sync.

## Architecture

Monorepo structure with yarn workspaces:

- `plugin/` - Obsidian plugin (TypeScript, Vite build)
- `functions/` - Firebase Cloud Functions (Node.js 18)
- `web/` - Web dashboard (SolidJS + TailwindCSS)
- `shared/` - Shared types and Firebase config

## Development Commands

**Pre-Release Validation (MANDATORY):**

```bash
cd plugin && yarn build    # Must compile without errors
yarn lint                  # From root - all workspaces must pass
```

### Plugin Development

```bash
cd plugin
yarn build          # Build plugin to dist/
```

### Firebase Functions

```bash
cd functions
yarn build          # Compile TypeScript
yarn serve          # Local development with emulators
yarn deploy         # Deploy to Firebase
yarn logs           # View function logs
```

**IMPORTANT**: Always use `yarn` instead of `npm` for all commands in this project!

### Web Dashboard

```bash
cd web
yarn dev            # Development server
yarn build          # Production build
yarn serve          # Preview build
```

### Code Quality

```bash
yarn lint           # Run ESLint across all workspaces (from root)
```

## Key Files and Entry Points

- **Plugin Entry**: `plugin/main.ts` - Core plugin logic with Firebase listeners
- **Settings UI**: `plugin/ui/SettingsTab.ts` - User configuration interface
- **Firebase Functions**: `functions/src/index.ts` - Webhook endpoint and auth
- **Web App**: `web/src/App.tsx` - Dashboard for webhook URL generation
- **Plugin Manifest**: `plugin/manifest.json` - Obsidian plugin metadata
- **Build Config**: `plugin/vite.config.js` - Custom Vite configuration for plugin build

## Development Best Practices

### üéØ Core Development Principles

1. **Monorepo Coordination**

   - Changes to `shared/` types affect all workspaces
   - Test plugin changes with Firebase emulators before deployment
   - Verify web dashboard changes don't break webhook generation

2. **Firebase Integration Testing**

   - Always test with emulators first: `cd functions && yarn serve`
   - Verify real-time sync works before deploying
   - Check auth token generation and validation

3. **Obsidian Plugin Standards**

   - Use `Notice` for user feedback, not console.log
   - Clean up Firebase listeners in onunload()
   - Test with different vault configurations

4. **Complete Feature Delivery**
   - Update all workspaces when adding new services (AudioPen, VoiceNotes, Alfie)
   - Update templates when adding new variables
   - Test sync modes (overwrite, append, prepend, new) thoroughly

### üìã Pre-Release Checklist

**Before releasing new plugin version:**

- ‚úÖ **Build Check**: `cd plugin && yarn build` - Must compile without errors
- ‚úÖ **Lint Check**: `yarn lint` from root - All workspaces pass
- ‚úÖ **Manifest Version**: Update version in `plugin/manifest.json`
- ‚úÖ **Firebase Deploy**: If functions changed, `cd functions && yarn deploy`
- ‚úÖ **Test Sync**: Verify sync works with all supported services
- ‚úÖ **Migration Path**: If breaking changes, provide clear migration instructions

## Development Patterns

1. **Firebase Real-time Sync**: Plugin listens to Firebase Realtime Database at `/users/{userId}/buffer/` for new notes
2. **Template System**: Templates use variable substitution (e.g., `{{note}}`, `{{date}}`, `{{tags}}`)
3. **Error Handling**: Use Obsidian's `Notice` for user notifications
4. **Status Updates**: Update status bar during sync operations
5. **TypeScript**: Strict typing with shared interfaces in `shared/` workspace

## Firebase Configuration

- **Region**: europe-west1
- **Authentication**: Custom tokens generated by Cloud Functions
- **Database Structure**: `/users/{userId}/buffer/` for note sync
- **Emulators**: Configured for local development (auth, functions, database, hosting)

## Important Notes

- Always build plugin with `yarn build` in the plugin directory before testing
- Firebase functions use Node.js 18 runtime
- Web dashboard is hosted at https://loud-thoughts.web.app
- Plugin supports AudioPen, VoiceNotes, and Alfie services
- No test suite - rely on ESLint and manual testing

### ü§ù Working Session Guidelines

**Planning and Communication:**

- Ask clarifying questions for complex plans - multiple implementation approaches require discussion
- Request business context when logic isn't clear
- Essential for longer plans: Ask several questions to gain crucial context

**Session Management:**

- Track progress with clear status updates for transparency
- Document as you go - implementation-time docs are more accurate
- Batch operations for efficiency when possible

**Common Anti-Patterns to Avoid:**

- TypeScript compilation issues - use proper type assertions with TODO comments
- Test suite mismatches - verify expectations match implementation
- Migration context loss - understand original data flow before refactoring

## Documentation Standards

### File Structure and Maintenance

**CLAUDE.md (this file)**

- Current implementation guidance and architecture
- Development commands and setup instructions
- Code patterns, conventions, and best practices
- **Contains current state only** - not backlog or completed work

**BACKLOG.md** (if used)

- Future work and sprint planning
- Prioritized features with implementation estimates
- **Forward-looking only** - no completed items

**CHANGELOG.md** (if used)

- Historical record of completed work with semantic versioning
- **Historical record only** - no future plans

### Release Notes Guidelines

**Tone and Style:**

- Friendly, conversational tone - like messaging a colleague
- Avoid superlatives and marketing speak ("rock solid", "bulletproof")
- Acknowledge that software is always work-in-progress
- Focus on practical impact on daily operations

**Structure Example:**

```markdown
## [Version] - [Date]

### üéØ What This Means for You

[Practical impact in conversational tone]

### ‚ú® User Experience Improvements

[User-facing changes and improvements]

### üîß What We Improved Behind the Scenes

[Technical improvements and bug fixes]

### üõ†Ô∏è Technical Implementation

[Architecture and development details]
```
